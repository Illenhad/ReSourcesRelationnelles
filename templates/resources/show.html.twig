{% extends 'base.html.twig' %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/rating.css') }}" type="text/css" xmlns="http://www.w3.org/1999/html">
    <link rel="stylesheet" href="{{ asset('css/show.css') }}" type="text/css">
    <link rel="stylesheet" href="{{ asset('css/stats.css') }}" type="text/css">
    <script src="{{ asset('js/jquery-3.5.1.min.js') }}"></script>
{% endblock %}

{% block body %}

    {% if app.user %}
        <a href="mailto:adresse@mail.fr?body=http://localhost{{ path('comment.show', {id: resource.id, slug: resource.slug}) }}"> Partager </a>
    {% endif %}

    <div class="resource-content">
        <div class="resource-description">
            <h1 class="resource-title">
                {{ resource.title }}
                {% if app.user %}
                    <a class="actions btn btn-icon" href="{{ path('addRemoveFav', {id: resource.id,url:app.request.requestUri }) }}">
                        {% if isFavorite %}
                            <span class="icon-favourite-remove"></span>
                        {% else %}
                            <span class="icon-favourite-add"></span>
                        {% endif %}
                    </a>
                {% endif %}

{#A MODIFIER#}
{#                <a style="display:block;text-align: right"#}
{#                   href="{{ path('addRemoveSide', {id: resource.id,url:app.request.requestUri }) }}">#}
{#                    {% if isSide %}#}
{#                        <img src="https://img.icons8.com/plasticine/100/000000/lock-2.png" title="Retirer "#}
{#                             style="width: 30px;height: 30px;"/>#}
{#                    {% else %}#}
{#                        <img src="https://img.icons8.com/carbon-copy/64/000000/lock-2.png" title="mettre de côte"#}
{#                             style="width: 30px;height: 30px;"/>#}
{#                    {% endif %}#}
{#                </a>#}

                <!--Gestion mise de côté-->
                {% if app.user %}
                    <a style="display:block;text-align: right"
                       href="{{ path('addRemoveSide', {id: resource.id,url:app.request.requestUri }) }}">
                        {% if isSide %}
                            <img src="https://img.icons8.com/plasticine/100/000000/lock-2.png" title="Retirer "
                                 style="width: 30px;height: 30px;"/>
                        {% else %}
                            <img src="https://img.icons8.com/carbon-copy/64/000000/lock-2.png" title="mettre de côte"
                                 style="width: 30px;height: 30px;"/>
                        {% endif %}
                    </a>
                {% endif %}


                <!--Gestion Exploité-->
                {% if app.user %}
                    <div>
                        Cette ressource vous est elle utile?
                        <a
                                href="{{ path('addRemoveUtility', {id: resource.id,url:app.request.requestUri,details:"non" }) }}">
                            {% if isUtility and isUtility.details=="non" %}
                                <img src="https://img.icons8.com/material-rounded/24/000000/thumbs-down.png" title="Non! "/>
                            {% else %}
                                <img src="https://img.icons8.com/material-outlined/24/000000/thumbs-down.png" title="Non!"/>
                            {% endif %}
                        </a>

                        <a
                                href="{{ path('addRemoveUtility', {id: resource.id,url:app.request.requestUri,details:"oui" }) }}">
                            {% if isUtility and isUtility.details=="oui" %}
                                <img src="https://img.icons8.com/material-rounded/24/000000/thumb-up.png" title="Oui!"/>
                            {% else %}
                                <img src="https://img.icons8.com/material-outlined/24/000000/thumb-up.png" title="Oui!"/>
                            {% endif %}
                        </a>
                    </div>
                {% endif %}

            </h1>
            <p class="author-date">posté par {{ resource.user.username }} le {{ resource.dateCreation|date("d/m/Y à H:i", "Europe/Paris") }}</p>
            <hr>
            <p class="resource-description-description">{{ resource.description }}</p>
        </div>
        <div>
            <h2 class="resource-informations-title">Informations</h2>
            <div class="stat-card stat-card-blue" title="Type de la ressource"><span class="icone-stat icone-info"></span><p>{{ resource.resourceType }}</p></div>
            <div class="stat-card stat-card-green" title="Ages concernés par la ressource"><span class="icone-stat icone-user"></span><p>{{ resource.ageCategory }}</p></div>
            <div class="stat-card stat-card-purple" title="Relations concernées par la ressource"><span class="icone-stat icone-share"></span><p>{{ resource.relationShip.label }}</p></div>
        </div>
    </div>

    {% if resource.comments is defined and resource.comments is not empty%}
        <div class="resource-comments">
            <h2 class="resource-comments-title">Evaluations</h2>
            {% for comment in resource.comments %}
                <div class="comment-content">
                    <hr>
                    {% if app.user== comment.user or is_granted('ROLE_MODERATEUR') %}
                        <div class="actions comment-actions">
                            {% if app.user== comment.user %}
                                <a href="{{ path('comment.edit', {id: comment.id} ) }}" class="btn btn-icon"><span class="icon-edit"></span></a>
                            {% endif %}
                            {% if app.user== comment.user or is_granted('ROLE_MODERATEUR') %}
                                <a href="{{ path('comment.delete', {id: comment.id}) }}" class="btn btn-icon"><span class="icon-delete"></span></a>
                            {% endif %}
                        </div>
                    {% endif %}
                    <div class="comment-title-content">
                        <h4 class="comment-title">{{ comment.title }}</h4>
                        <div class="rating-show">
                            {% for i in  1..comment.valuation %}
                                <input type="radio" name="rating-show" value="{{ i }}" id="{{ i }}">
                                <label for="{{ i }}">☆</label>
                            {% endfor %}
                        </div>
                    </div>
                    <p><span class="commentary-author">{{ comment.user.username }}</span><span class="author-date"> le {{ comment.commentDate|date("d/m/Y à H:i", "Europe/Paris") }}</span></p>
{#                    <p class="author-date">De {{ comment.user.username }} le {{ comment.commentDate|date("d/m/Y à H:i", "Europe/Paris") }}</p>#}
                    <p class="comment-text">{{ comment.content }}</p>
                </div>
            {% endfor %}
        </div>
        <button style="margin-bottom: 30px" id="more-less-comment" class="btn btn-more-less" onclick="setShowComments()"></button>
    {% endif %}

    <div class="charte-form">
        {{ form_start(form) }}
        <h3>Votre évaluation</h3>
        <ul class="rating">
            {% for i in range(1, 5) %}
                <li class="rating-item {{ (i == 5) ? 'active' : '' }}" data-rate="{{ i }}"></li>
            {% endfor %}
        </ul>

        {{ form_widget(form.title) }}
        {{ form_widget(form.content) }}
        {{ form_widget(form.valuation) }}
        {{ form_widget(form.submit) }}
        {{ form_end(form) }}
    </div>

    <div>
        {% include "commentary/index.html.twig"  with {"commentaries": resource.commentaries, "resource": resource}%}
    </div>

    <a class="btn btn-primary" href="{{ path('resources') }}">Retour</a>

    {% block javascripts %}
        <script>
            $(document).ready(function () {
                const container = document.querySelector('.rating');
                const items = container.querySelectorAll('.rating-item');
                container.onclick = e => {
                    const elClass = e.target.classList;
                    if (!elClass.contains('active')) {
                        items.forEach(
                            item => item.classList.remove('active')
                        );
                        $("#comment_valuation").val(e.target.getAttribute("data-rate"));
                        elClass.add('active');
                    }
                };
            });

            /*COMMENTS MANAGING*/
            var showComments = true;
            var allComments = document.getElementsByClassName('comment-content');
            var button = document.querySelector('#more-less-comment');
            comments = Array.prototype.slice.call(allComments);
            if(comments.length > 5) {
                comments = comments.splice(5, comments.length - 5);
                setShowComments();
            } else {
                button.style.display = 'none';
            }
            console.log('init, show = ' + showComments);
            function setShowComments() {
                showComments = !showComments;
                if (showComments) {
                    comments.forEach(showHideComments);
                    button.innerHTML = '<span class="icon-upper-arrow"></span> Voir moins';
                } else {
                    comments.forEach(showHideComments);
                    button.innerHTML = '<span class="icon-lower-arrow"></span> Voir plus (' + comments.length + ')';
                }
            }
            function showHideComments(item) {
                item.style.display = showComments ? 'block' : 'none';
            }
        </script>

    {% endblock %}
{% endblock %}